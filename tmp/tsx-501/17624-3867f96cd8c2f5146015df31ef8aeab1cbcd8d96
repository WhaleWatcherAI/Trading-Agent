{"code":"__filename=\"/Users/coreycosta/trading-agent/lib/meanReversionAgent.ts\";(()=>{\n\"use strict\";var __defProp=Object.defineProperty;var __getOwnPropDesc=Object.getOwnPropertyDescriptor;var __getOwnPropNames=Object.getOwnPropertyNames;var __hasOwnProp=Object.prototype.hasOwnProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});var __export=(target,all)=>{for(var name in all)__defProp(target,name,{get:all[name],enumerable:true})};var __copyProps=(to,from,except,desc)=>{if(from&&typeof from===\"object\"||typeof from===\"function\"){for(let key of __getOwnPropNames(from))if(!__hasOwnProp.call(to,key)&&key!==except)__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable})}return to};var __toCommonJS=mod=>__copyProps(__defProp({},\"__esModule\",{value:true}),mod);var meanReversionAgent_exports={};__export(meanReversionAgent_exports,{calculateTechnicals:()=>calculateTechnicals,checkMeanReversionExit:()=>checkMeanReversionExit,generateMeanReversionSignal:()=>generateMeanReversionSignal,generateMeanReversionSignalFromTechnicals:()=>generateMeanReversionSignalFromTechnicals});module.exports=__toCommonJS(meanReversionAgent_exports);var import_gexCalculator=require(\"./gexCalculator\");var import_technicalindicators=require(\"technicalindicators\");function calculateTechnicals(closes,rsiPeriod=14,bbPeriod=20,bbStdDev=2){if(closes.length<Math.max(rsiPeriod,bbPeriod)){return null}const rsiValues=import_technicalindicators.RSI.calculate({values:closes,period:rsiPeriod});const rsi=rsiValues[rsiValues.length-1];const bbValues=import_technicalindicators.BollingerBands.calculate({values:closes,period:bbPeriod,stdDev:bbStdDev});const latestBB=bbValues[bbValues.length-1];const smaValues=import_technicalindicators.SMA.calculate({values:closes,period:bbPeriod});const sma20=smaValues[smaValues.length-1];if(!rsi||!latestBB||!sma20){return null}return{rsi,bbUpper:latestBB.upper,bbMiddle:latestBB.middle,bbLower:latestBB.lower,bbWidth:latestBB.upper-latestBB.lower,sma20}}__name(calculateTechnicals,\"calculateTechnicals\");function generateMeanReversionSignalFromTechnicals(symbol,currentPrice,priceHistory,netGex,config={}){const{rsiPeriod=14,rsiOversold=30,rsiOverbought=70,bbPeriod=20,bbStdDev=2,bbThreshold=.005,stopLossPercent=.01}=config;const timestamp=new Date().toISOString();const regime=netGex>0?\"positive_gex\":\"negative_gex\";const defaultSignal={symbol,timestamp,action:\"none\",direction:\"none\",entryPrice:currentPrice,stopLoss:null,target:null,rsi:null,bbUpper:null,bbMiddle:null,bbLower:null,bbPercentB:null,netGex,regime,rationale:[]};if(!priceHistory||priceHistory.length<Math.max(rsiPeriod,bbPeriod)){defaultSignal.rationale.push(`Insufficient price history (${priceHistory?.length||0} bars, need ${Math.max(rsiPeriod,bbPeriod)})`);return defaultSignal}const technicals=calculateTechnicals(priceHistory,rsiPeriod,bbPeriod,bbStdDev);if(!technicals){defaultSignal.rationale.push(\"Failed to calculate technical indicators\");return defaultSignal}const{rsi,bbUpper,bbMiddle,bbLower,bbWidth}=technicals;const bbPercentB=(currentPrice-bbLower)/(bbWidth||1);const rationale=[`Net GEX: $${(netGex/1e6).toFixed(1)}M`,`RSI: ${rsi.toFixed(1)} | BB: $${bbLower.toFixed(2)} - $${bbMiddle.toFixed(2)} - $${bbUpper.toFixed(2)}`,`Current price: $${currentPrice.toFixed(2)} (BB %B: ${(bbPercentB*100).toFixed(1)}%)`];const distanceFromLowerBB=Math.abs(currentPrice-bbLower)/currentPrice;if(rsi<rsiOversold&&distanceFromLowerBB<bbThreshold){const stopLoss=currentPrice*(1-stopLossPercent);const target=bbMiddle;rationale.push(`\\u{1F7E2} LONG: RSI oversold (${rsi.toFixed(1)}) + price at lower BB`);rationale.push(`Stop: $${stopLoss.toFixed(2)} | Target: $${target.toFixed(2)}`);return{symbol,timestamp,action:\"buy\",direction:\"long\",entryPrice:currentPrice,stopLoss,target,rsi,bbUpper,bbMiddle,bbLower,bbPercentB,netGex,regime,rationale}}const distanceFromUpperBB=Math.abs(bbUpper-currentPrice)/currentPrice;if(rsi>rsiOverbought&&distanceFromUpperBB<bbThreshold){const stopLoss=currentPrice*(1+stopLossPercent);const target=bbMiddle;rationale.push(`\\u{1F534} SHORT: RSI overbought (${rsi.toFixed(1)}) + price at upper BB`);rationale.push(`Stop: $${stopLoss.toFixed(2)} | Target: $${target.toFixed(2)}`);return{symbol,timestamp,action:\"sell\",direction:\"short\",entryPrice:currentPrice,stopLoss,target,rsi,bbUpper,bbMiddle,bbLower,bbPercentB,netGex,regime,rationale}}if(rsi>=rsiOversold&&rsi<=rsiOverbought){rationale.push(`RSI neutral (${rsi.toFixed(1)}) - waiting for oversold/overbought`)}else if(distanceFromLowerBB>=bbThreshold&&distanceFromUpperBB>=bbThreshold){rationale.push(`Price not at Bollinger Band extremes - waiting`)}else{rationale.push(`No clear mean reversion setup`)}return{symbol,timestamp,action:\"none\",direction:\"none\",entryPrice:currentPrice,stopLoss:null,target:null,rsi,bbUpper,bbMiddle,bbLower,bbPercentB,netGex,regime,rationale}}__name(generateMeanReversionSignalFromTechnicals,\"generateMeanReversionSignalFromTechnicals\");async function generateMeanReversionSignal(config,priceHistory){const{symbol,date,mode=\"intraday\"}=config;const bypassGex=process.env.BYPASS_GEX===\"true\";const historicalPrice=priceHistory&&priceHistory.length>0?priceHistory[priceHistory.length-1]:void 0;let currentPrice;let netGex;let regime;let gex=null;if(bypassGex&&Number.isFinite(historicalPrice??NaN)){currentPrice=historicalPrice;netGex=1;regime=\"positive_gex\"}else{gex=await(0,import_gexCalculator.calculateGexForSymbol)(symbol,mode,date);currentPrice=gex.stockPrice;netGex=gex.summary.netGex;regime=netGex>0?\"positive_gex\":\"negative_gex\"}if(!Number.isFinite(currentPrice)||currentPrice<=0){throw new Error(`Invalid reference price for ${symbol}`)}const timestamp=new Date().toISOString();const defaultSignal={symbol,timestamp,action:\"none\",direction:\"none\",entryPrice:currentPrice,stopLoss:null,target:null,rsi:null,bbUpper:null,bbMiddle:null,bbLower:null,bbPercentB:null,netGex,regime,rationale:[]};if(!bypassGex&&netGex<=0){defaultSignal.rationale.push(`Net GEX is negative ($${(netGex/1e6).toFixed(1)}M) - no mean reversion regime`);return defaultSignal}if(!priceHistory){if(bypassGex){defaultSignal.rationale.push(\"BYPASS_GEX enabled (GEX checks skipped)\")}return defaultSignal}if(bypassGex){defaultSignal.rationale.push(\"BYPASS_GEX enabled (GEX checks skipped)\")}else if(gex){defaultSignal.rationale.push(`Net GEX: $${(netGex/1e6).toFixed(1)}M (regime ${regime})`)}return generateMeanReversionSignalFromTechnicals(symbol,currentPrice,priceHistory,netGex,config)}__name(generateMeanReversionSignal,\"generateMeanReversionSignal\");function checkMeanReversionExit(currentPrice,signal,currentRSI){const{direction,stopLoss,target}=signal;if(direction===\"none\"){return{shouldExit:false,exitReason:\"none\",exitPrice:currentPrice}}if(stopLoss!==null){if(direction===\"long\"&&currentPrice<=stopLoss){return{shouldExit:true,exitReason:\"stop\",exitPrice:currentPrice}}if(direction===\"short\"&&currentPrice>=stopLoss){return{shouldExit:true,exitReason:\"stop\",exitPrice:currentPrice}}}if(target!==null){if(direction===\"long\"&&currentPrice>=target){return{shouldExit:true,exitReason:\"target\",exitPrice:currentPrice}}if(direction===\"short\"&&currentPrice<=target){return{shouldExit:true,exitReason:\"target\",exitPrice:currentPrice}}}return{shouldExit:false,exitReason:\"none\",exitPrice:currentPrice}}__name(checkMeanReversionExit,\"checkMeanReversionExit\");0&&(module.exports={calculateTechnicals,checkMeanReversionExit,generateMeanReversionSignal,generateMeanReversionSignalFromTechnicals});\n})()\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/Users/coreycosta/trading-agent/lib/meanReversionAgent.ts"],"sourcesContent":[null]}}