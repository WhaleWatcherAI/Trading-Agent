{"code":"__filename=\"/Users/coreycosta/trading-agent/lib/coinbaseWebSocket.ts\";(()=>{\n\"use strict\";var __create=Object.create;var __defProp=Object.defineProperty;var __getOwnPropDesc=Object.getOwnPropertyDescriptor;var __getOwnPropNames=Object.getOwnPropertyNames;var __getProtoOf=Object.getPrototypeOf;var __hasOwnProp=Object.prototype.hasOwnProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});var __export=(target,all)=>{for(var name in all)__defProp(target,name,{get:all[name],enumerable:true})};var __copyProps=(to,from,except,desc)=>{if(from&&typeof from===\"object\"||typeof from===\"function\"){for(let key of __getOwnPropNames(from))if(!__hasOwnProp.call(to,key)&&key!==except)__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable})}return to};var __toESM=(mod,isNodeMode,target)=>(target=mod!=null?__create(__getProtoOf(mod)):{},__copyProps(isNodeMode||!mod||!mod.__esModule?__defProp(target,\"default\",{value:mod,enumerable:true}):target,mod));var __toCommonJS=mod=>__copyProps(__defProp({},\"__esModule\",{value:true}),mod);var coinbaseWebSocket_exports={};__export(coinbaseWebSocket_exports,{CoinbaseWebSocketClient:()=>CoinbaseWebSocketClient});module.exports=__toCommonJS(coinbaseWebSocket_exports);var import_ws=__toESM(require(\"ws\"));var import_events=require(\"events\");class CoinbaseWebSocketClient extends import_events.EventEmitter{constructor(config){super();this.ws=null;this.reconnectAttempts=0;this.maxReconnectAttempts=10;this.reconnectDelay=5e3;this.isShuttingDown=false;this.pingInterval=null;this.isConnected=false;this.latestPrices=new Map;this.bars=new Map;this.symbols=config.symbols;this.wsUrl=config.wsUrl||\"wss://ws-feed.exchange.coinbase.com\"}static{__name(this,\"CoinbaseWebSocketClient\")}connect(){if(this.ws){console.log(\"[Coinbase WS] Already connected\");return}console.log(`[Coinbase WS] Connecting to ${this.wsUrl}...`);this.ws=new import_ws.default(this.wsUrl);this.ws.on(\"open\",()=>{console.log(\"[Coinbase WS] Connected\");this.isConnected=true;this.reconnectAttempts=0;this.subscribe();this.startPingInterval()});this.ws.on(\"message\",data=>{try{const message=JSON.parse(data.toString());this.handleMessage(message)}catch(err){console.error(\"[Coinbase WS] Failed to parse message:\",err)}});this.ws.on(\"error\",error=>{console.error(\"[Coinbase WS] Error:\",error.message)});this.ws.on(\"close\",()=>{console.log(\"[Coinbase WS] Connection closed\");this.isConnected=false;this.stopPingInterval();if(!this.isShuttingDown){this.attemptReconnect()}})}subscribe(){if(!this.ws||this.ws.readyState!==import_ws.default.OPEN){console.error(\"[Coinbase WS] Cannot subscribe - connection not open\");return}const subscribeMessage={type:\"subscribe\",product_ids:this.symbols,channels:[\"ticker\",\"matches\"]};console.log(`[Coinbase WS] Subscribing to: ${this.symbols.join(\", \")}`);this.ws.send(JSON.stringify(subscribeMessage))}handleMessage(message){if(message.type===\"subscriptions\"){console.log(\"[Coinbase WS] Subscribed to channels:\",JSON.stringify(message.channels));return}if(message.type===\"ticker\"){this.handleTicker(message)}else if(message.type===\"match\"){this.handleMatch(message)}}handleTicker(ticker){const symbol=ticker.product_id;const price=parseFloat(ticker.price);if(!Number.isFinite(price)){return}this.latestPrices.set(symbol,price);const tick={price,time:ticker.time,size:parseFloat(ticker.last_size||\"0\"),side:ticker.side};this.emit(\"tick\",symbol,tick)}handleMatch(match){const symbol=match.product_id;const price=parseFloat(match.price);const size=parseFloat(match.size);if(!Number.isFinite(price)){return}this.latestPrices.set(symbol,price);const tick={price,time:match.time,size,side:match.side};this.emit(\"tick\",symbol,tick);this.emit(\"trade\",symbol,tick)}startPingInterval(){this.stopPingInterval();this.pingInterval=setInterval(()=>{if(this.ws&&this.ws.readyState===import_ws.default.OPEN){this.ws.ping()}},3e4)}stopPingInterval(){if(this.pingInterval){clearInterval(this.pingInterval);this.pingInterval=null}}attemptReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){console.error(\"[Coinbase WS] Max reconnect attempts reached\");return}this.reconnectAttempts++;const delay=this.reconnectDelay*this.reconnectAttempts;console.log(`[Coinbase WS] Reconnecting in ${delay}ms (attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts})`);setTimeout(()=>{this.ws=null;this.connect()},delay)}getLatestPrice(symbol){return this.latestPrices.get(symbol)??null}async fetchCandles(symbol,granularity,limit=300){const url=`https://api.exchange.coinbase.com/products/${symbol}/candles?granularity=${granularity}`;try{const response=await fetch(url);if(!response.ok){throw new Error(`Coinbase API error: ${response.status} ${response.statusText}`)}const data=await response.json();const bars=data.map(candle=>({t:new Date(candle[0]*1e3).toISOString(),o:candle[3],h:candle[2],l:candle[1],c:candle[4],v:candle[5],partial:false}));bars.sort((a,b)=>new Date(a.t).getTime()-new Date(b.t).getTime());return bars.slice(-limit)}catch(error){console.error(`[Coinbase REST] Failed to fetch candles for ${symbol}:`,error);return[]}}async getRecentBars(symbol,interval,count){const granularityMap={\"1Min\":60,\"5Min\":300,\"15Min\":900,\"1Hour\":3600};const granularity=granularityMap[interval];const cacheKey=`${symbol}-${interval}`;if(!this.bars.has(symbol)){this.bars.set(symbol,new Map)}const symbolBars=this.bars.get(symbol);let cached=symbolBars.get(interval)||[];const now=Date.now();const lastBar=cached[cached.length-1];const lastBarTime=lastBar?new Date(lastBar.t).getTime():0;const isStale=now-lastBarTime>6e4;if(cached.length===0||isStale){cached=await this.fetchCandles(symbol,granularity,count);symbolBars.set(interval,cached)}return cached.slice(-count)}disconnect(){console.log(\"[Coinbase WS] Disconnecting...\");this.isShuttingDown=true;this.stopPingInterval();if(this.ws){this.ws.close();this.ws=null}this.isConnected=false}connected(){return this.isConnected}}0&&(module.exports={CoinbaseWebSocketClient});\n})()\n","warnings":[],"map":{"version":3,"mappings":"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","names":["WebSocket"],"ignoreList":[],"sources":["/Users/coreycosta/trading-agent/lib/coinbaseWebSocket.ts"],"sourcesContent":[null]}}