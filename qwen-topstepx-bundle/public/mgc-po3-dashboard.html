<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MGC PO3 Strategy - Live Dashboard</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #0f172a; color: #e2e8f0; }
        .header { background: #1e293b; padding: 1rem; border-bottom: 1px solid #334155; }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
        .title { font-size: 1.5rem; font-weight: bold; color: #f1f5f9; }
        .subtitle { font-size: 0.875rem; color: #94a3b8; margin-top: 0.25rem; }
        .control-panel { display: flex; gap: 1rem; align-items: center; }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 0.375rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-start { background: #22c55e; color: white; }
        .btn-start:hover:not(:disabled) { background: #16a34a; }
        .btn-stop { background: #f97316; color: white; }
        .btn-stop:hover { background: #ea580c; }
        .btn-flatten { background: #ef4444; color: white; }
        .btn-flatten:hover { background: #dc2626; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .trading-status { padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-size: 0.875rem; font-weight: 600; }
        .status-active { background: #16a34a; color: white; }
        .status-inactive { background: #dc2626; color: white; }
        .status-bar { background: #1e293b; padding: 0.75rem; border-bottom: 1px solid #334155; }
        .status-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .status-item { display: flex; align-items: center; gap: 0.5rem; }
        .status-label { color: #94a3b8; font-size: 0.875rem; }
        .status-value { color: #f1f5f9; font-weight: 600; }
        .status-value.positive { color: #22c55e; }
        .status-value.negative { color: #ef4444; }
        .status-connected { width: 8px; height: 8px; border-radius: 50%; background: #22c55e; animation: pulse 2s infinite; }
        .status-disconnected { width: 8px; height: 8px; border-radius: 50%; background: #ef4444; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }
        .chart-container { background: #1e293b; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; }
        .chart-title { color: #f1f5f9; font-weight: 600; margin-bottom: 0.5rem; }
        .chart-wrapper { position: relative; }
        .session-panel { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
        .session-card { background: #1e293b; border-radius: 0.5rem; padding: 1rem; }
        .session-header { font-weight: 600; color: #f1f5f9; margin-bottom: 0.5rem; }
        .session-info { color: #94a3b8; font-size: 0.875rem; }
        .session-active { border: 2px solid #22c55e; }
        .manipulation-indicator { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-size: 0.875rem; font-weight: 600; margin-left: 0.5rem; }
        .manipulation-bullish { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .manipulation-bearish { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .position-monitor { background: #1e293b; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; }
        .position-header { font-weight: 600; color: #f1f5f9; margin-bottom: 1rem; }
        .position-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
        .position-item { }
        .position-label { color: #94a3b8; font-size: 0.875rem; }
        .position-value { color: #f1f5f9; font-weight: 600; margin-top: 0.25rem; }
        .no-position { color: #94a3b8; font-style: italic; }
        .trade-history { background: #1e293b; border-radius: 0.5rem; padding: 1rem; }
        .trade-header { font-weight: 600; color: #f1f5f9; margin-bottom: 1rem; }
        .trade-table { width: 100%; border-collapse: collapse; }
        .trade-table th { text-align: left; padding: 0.5rem; color: #94a3b8; font-size: 0.875rem; border-bottom: 1px solid #334155; }
        .trade-table td { padding: 0.5rem; color: #e2e8f0; }
        .trade-table tr:hover { background: rgba(51, 65, 85, 0.3); }
        .trade-side-long { color: #22c55e; font-weight: 600; }
        .trade-side-short { color: #ef4444; font-weight: 600; }
        .trade-pnl-positive { color: #22c55e; font-weight: 600; }
        .trade-pnl-negative { color: #ef4444; font-weight: 600; }
        .alert-box { position: fixed; top: 1rem; right: 1rem; max-width: 400px; padding: 1rem; border-radius: 0.5rem; animation: slideIn 0.3s; z-index: 1000; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .alert-success { background: #16a34a; color: white; }
        .alert-error { background: #dc2626; color: white; }
        .alert-warning { background: #f97316; color: white; }
        .alert-info { background: #0284c7; color: white; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div>
                <div class="title">MGC Power of Three (PO3) Strategy - Live Trading</div>
                <div class="subtitle">
                    <span id="symbol">MGCZ5</span> |
                    Asia (20:00-00:00) ‚Üí London (02:00-05:00) ‚Üí NY (09:30-11:30, 13:30-15:30 ET)
                </div>
            </div>
            <div class="control-panel">
                <button id="btnStart" class="btn btn-start">‚ñ∂ Start Trading</button>
                <button id="btnStop" class="btn btn-stop" style="display: none;">‚è∏ Stop Trading</button>
                <button id="btnFlatten" class="btn btn-flatten" disabled>‚èè Flatten Position</button>
                <div id="tradingStatus" class="trading-status status-inactive">Inactive</div>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <div class="status-content">
            <div class="status-item">
                <span class="status-label">Account:</span>
                <span id="accountBalance" class="status-value">$0.00</span>
            </div>
            <div class="status-item">
                <span class="status-label">Daily P&L:</span>
                <span id="dailyPnl" class="status-value">$0.00</span>
                <span id="dailyLimit" style="color: #94a3b8; font-size: 0.75rem; margin-left: 0.25rem;">/ -$2,000</span>
            </div>
            <div class="status-item">
                <span class="status-label">Open P&L:</span>
                <span id="openPnl" class="status-value">$0.00</span>
            </div>
            <div class="status-item">
                <span class="status-label">Trades:</span>
                <span id="tradeCount" class="status-value">0</span>
            </div>
            <div class="status-item">
                <span class="status-label">Realized:</span>
                <span id="realizedPnl" class="status-value">$0.00</span>
            </div>
            <div class="status-item">
                <span class="status-label">Connection:</span>
                <div id="connectionStatus" class="status-disconnected"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="session-panel">
            <div class="session-card" id="asiaCard">
                <div class="session-header">üåô Asia Session (Accumulation)</div>
                <div class="session-info">
                    <div>Range: <span id="asiaRange">-</span></div>
                    <div>High: <span id="asiaHigh">-</span></div>
                    <div>Low: <span id="asiaLow">-</span></div>
                </div>
            </div>
            <div class="session-card" id="londonCard">
                <div class="session-header">üîî London Session (Manipulation)</div>
                <div class="session-info">
                    <div>Status: <span id="londonStatus">Waiting...</span></div>
                    <div>Sweep: <span id="londonSweep">-</span></div>
                    <div>Type: <span id="londonType">-</span></div>
                </div>
            </div>
            <div class="session-card" id="nyCard">
                <div class="session-header">üìà NY Session (Distribution)</div>
                <div class="session-info">
                    <div>Status: <span id="nyStatus">Waiting...</span></div>
                    <div>Entered: <span id="nyEntered">No</span></div>
                    <div>Target: <span id="nyTarget">Asia Midpoint</span></div>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">
                Price Chart
                <span id="manipulationIndicator"></span>
                <span id="entryIndicator" style="margin-left: 10px;"></span>
            </div>
            <div id="mainChart" class="chart-wrapper" style="height: 500px;"></div>
        </div>

        <div class="position-monitor">
            <div class="position-header">Current Position</div>
            <div id="positionInfo" class="no-position">No active position</div>
        </div>

        <div class="activity-log" style="background: #1e293b; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <div class="trade-header" style="margin-bottom: 10px;">Strategy Activity Log</div>
            <div id="activityLog" style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; color: #94a3b8;">
                <div style="color: #64748b;">Waiting for activity...</div>
            </div>
        </div>

        <div class="trade-history">
            <div class="trade-header">Recent Trades (Last 10)</div>
            <table class="trade-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Side</th>
                        <th>Entry</th>
                        <th>Exit</th>
                        <th>Reason</th>
                        <th>P&L</th>
                    </tr>
                </thead>
                <tbody id="tradeList"></tbody>
            </table>
        </div>
    </div>

    <script>
        // Global state
        let socket = null;
        let mainChart = null;
        let candleSeries = null;
        let asiaHighSeries = null;
        let asiaLowSeries = null;
        let asiaMidSeries = null;
        let londonSweepSeries = null;
        let tradingEnabled = false;
        let currentPosition = null;
        let currentDay = null;
        let trades = [];
        let chartDataLoaded = false;
        let isUpdatingCharts = false;

        // Initialize charts
        function initCharts() {
            const mainContainer = document.getElementById('mainChart');
            mainChart = LightweightCharts.createChart(mainContainer, {
                width: mainContainer.clientWidth,
                height: 500,
                layout: {
                    background: { type: LightweightCharts.ColorType.Solid, color: '#1e293b' },
                    textColor: '#e2e8f0',
                },
                grid: {
                    vertLines: { color: 'rgba(14,23,38,0.4)' },
                    horzLines: { color: 'rgba(14,23,38,0.4)' },
                },
                timeScale: {
                    borderColor: '#334155',
                    timeVisible: true,
                    secondsVisible: false,
                },
                rightPriceScale: {
                    borderColor: '#334155',
                },
            });

            candleSeries = mainChart.addCandlestickSeries({
                upColor: '#22c55e',
                downColor: '#ef4444',
                borderDownColor: '#dc2626',
                borderUpColor: '#16a34a',
                wickDownColor: '#ef4444',
                wickUpColor: '#22c55e',
            });

            // Asia High line
            asiaHighSeries = mainChart.addLineSeries({
                color: '#3b82f6',
                lineWidth: 2,
                lineStyle: 2,
                priceLineVisible: false,
                title: 'Asia High',
            });

            // Asia Low line
            asiaLowSeries = mainChart.addLineSeries({
                color: '#3b82f6',
                lineWidth: 2,
                lineStyle: 2,
                priceLineVisible: false,
                title: 'Asia Low',
            });

            // Asia Midpoint line
            asiaMidSeries = mainChart.addLineSeries({
                color: '#94a3b8',
                lineWidth: 1,
                lineStyle: 2,
                priceLineVisible: false,
                title: 'Asia Mid',
            });

            // London Sweep marker
            londonSweepSeries = mainChart.addLineSeries({
                color: '#f59e0b',
                lineWidth: 0,
                pointMarkersVisible: true,
                lastValueVisible: false,
                priceLineVisible: false,
                title: 'London Sweep',
            });

            window.addEventListener('resize', () => {
                if (mainChart) mainChart.applyOptions({ width: mainContainer.clientWidth });
            });
        }

        // Update charts with data
        async function updateCharts(data) {
            if (!data || !Array.isArray(data) || data.length === 0) {
                console.log('No data to update charts');
                return;
            }

            if (!mainChart || !candleSeries) {
                console.log('Charts not initialized yet, retrying in 200ms...');
                setTimeout(() => updateCharts(data), 200);
                return;
            }

            if (isUpdatingCharts) {
                console.log('Charts are already being updated, skipping...');
                return;
            }

            isUpdatingCharts = true;
            console.log('Starting chart update with', data.length, 'bars');

            // Prepare candle data
            const candleData = data
                .filter(point =>
                    point &&
                    typeof point.open === 'number' &&
                    typeof point.high === 'number' &&
                    typeof point.low === 'number' &&
                    typeof point.close === 'number' &&
                    Number.isFinite(point.open) &&
                    Number.isFinite(point.high) &&
                    Number.isFinite(point.low) &&
                    Number.isFinite(point.close) &&
                    point.timestamp
                )
                .map(point => ({
                    time: Math.floor(new Date(point.timestamp).getTime() / 1000),
                    open: point.open,
                    high: point.high,
                    low: point.low,
                    close: point.close
                }))
                .sort((a, b) => a.time - b.time);

            if (candleData.length > 0 && candleSeries) {
                try {
                    candleSeries.setData(candleData);
                    console.log('Set candlestick data:', candleData.length, 'bars');
                } catch (e) {
                    console.error('Error setting candle data:', e);
                }
            }

            // Update Asia High line
            const asiaHighData = data
                .filter(point => point && typeof point.asiaHigh === 'number' && Number.isFinite(point.asiaHigh))
                .map(point => ({
                    time: Math.floor(new Date(point.timestamp).getTime() / 1000),
                    value: point.asiaHigh
                }))
                .sort((a, b) => a.time - b.time);

            if (asiaHighData.length > 0 && asiaHighSeries) {
                try {
                    asiaHighSeries.setData(asiaHighData);
                    console.log('Set Asia High data:', asiaHighData.length, 'points');
                } catch (e) {
                    console.error('Error setting Asia High:', e);
                }
            }

            // Update Asia Low line
            const asiaLowData = data
                .filter(point => point && typeof point.asiaLow === 'number' && Number.isFinite(point.asiaLow))
                .map(point => ({
                    time: Math.floor(new Date(point.timestamp).getTime() / 1000),
                    value: point.asiaLow
                }))
                .sort((a, b) => a.time - b.time);

            if (asiaLowData.length > 0 && asiaLowSeries) {
                try {
                    asiaLowSeries.setData(asiaLowData);
                    console.log('Set Asia Low data:', asiaLowData.length, 'points');
                } catch (e) {
                    console.error('Error setting Asia Low:', e);
                }
            }

            // Update Asia Midpoint line
            const asiaMidData = data
                .filter(point => point && typeof point.asiaMidpoint === 'number' && Number.isFinite(point.asiaMidpoint))
                .map(point => ({
                    time: Math.floor(new Date(point.timestamp).getTime() / 1000),
                    value: point.asiaMidpoint
                }))
                .sort((a, b) => a.time - b.time);

            if (asiaMidData.length > 0 && asiaMidSeries) {
                try {
                    asiaMidSeries.setData(asiaMidData);
                    console.log('Set Asia Mid data:', asiaMidData.length, 'points');
                } catch (e) {
                    console.error('Error setting Asia Mid:', e);
                }
            }

            // Update London Sweep markers
            const londonSweepData = data
                .filter(point => point && typeof point.londonSweep === 'number' && Number.isFinite(point.londonSweep))
                .map(point => ({
                    time: Math.floor(new Date(point.timestamp).getTime() / 1000),
                    value: point.londonSweep
                }))
                .sort((a, b) => a.time - b.time);

            if (londonSweepData.length > 0 && londonSweepSeries) {
                try {
                    londonSweepSeries.setData(londonSweepData);
                    console.log('Set London Sweep data:', londonSweepData.length, 'points');
                } catch (e) {
                    console.error('Error setting London Sweep:', e);
                }
            }

            if (mainChart && candleData.length > 0) {
                try {
                    mainChart.timeScale().fitContent();
                    console.log('Main chart fitted to content');
                } catch (e) {
                    console.error('Error fitting main chart:', e);
                }
            }

            console.log('Chart update complete');
            chartDataLoaded = true;
            isUpdatingCharts = false;
        }

        // Load account status
        async function loadAccountStatus() {
            try {
                const response = await fetch('/api/status');
                if (!response.ok) throw new Error('Failed to fetch status');
                const data = await response.json();

                console.log('Loaded status:', data);
                updateStatus(data);
            } catch (error) {
                console.error('Failed to load status:', error);
            }
        }

        // Update UI elements
        function updateStatus(data) {
            if (!data) return;

            // Update account balance
            if (data.accountStatus?.balance != null) {
                document.getElementById('accountBalance').textContent = `$${data.accountStatus.balance.toFixed(2)}`;
            }

            // Update daily P&L
            if (data.accountStatus?.dailyPnL != null) {
                const pnlElement = document.getElementById('dailyPnl');
                pnlElement.textContent = `$${data.accountStatus.dailyPnL.toFixed(2)}`;
                pnlElement.className = data.accountStatus.dailyPnL >= 0 ? 'status-value positive' : 'status-value negative';

                if (data.accountStatus.dailyPnL <= -1500) {
                    document.getElementById('dailyLimit').style.color = '#ef4444';
                }
            }

            // Update trading status
            if (data.tradingEnabled != null) {
                tradingEnabled = data.tradingEnabled;
                const statusEl = document.getElementById('tradingStatus');
                statusEl.textContent = tradingEnabled ? 'Active' : 'Inactive';
                statusEl.className = tradingEnabled ? 'trading-status status-active' : 'trading-status status-inactive';

                document.getElementById('btnStart').style.display = tradingEnabled ? 'none' : 'inline-block';
                document.getElementById('btnStop').style.display = tradingEnabled ? 'inline-block' : 'none';
            }

            // Update realized PnL
            if (data.performance?.realizedPnL != null) {
                const realizedEl = document.getElementById('realizedPnl');
                realizedEl.textContent = `$${data.performance.realizedPnL.toFixed(2)}`;
                realizedEl.className = data.performance.realizedPnL >= 0 ? 'status-value positive' : 'status-value negative';
            }

            // Update trade count
            if (data.performance?.tradesCount != null) {
                document.getElementById('tradeCount').textContent = data.performance.tradesCount;
            }

            // Update currentDay (PO3 session data)
            if (data.currentDay) {
                currentDay = data.currentDay;
                updateSessionDisplay();
            }

            // Update manipulation indicator
            if (data.currentDay?.londonManipulation) {
                const indicator = document.getElementById('manipulationIndicator');
                indicator.className = `manipulation-indicator manipulation-${data.currentDay.londonManipulation}`;
                indicator.textContent = `${data.currentDay.londonManipulation.toUpperCase()} Manipulation`;
            } else {
                document.getElementById('manipulationIndicator').textContent = '';
            }

            // Update position
            if (data.position) {
                currentPosition = data.position;
                updatePositionDisplay();
                document.getElementById('btnFlatten').disabled = false;
            } else {
                currentPosition = null;
                document.getElementById('positionInfo').innerHTML = '<div class="no-position">No active position</div>';
                document.getElementById('btnFlatten').disabled = true;
                document.getElementById('openPnl').textContent = '$0.00';
            }
        }

        function updateSessionDisplay() {
            if (!currentDay) return;

            // Asia session
            if (currentDay.asiaHigh != null && currentDay.asiaLow != null) {
                const range = currentDay.asiaHigh - currentDay.asiaLow;
                document.getElementById('asiaRange').textContent = range.toFixed(2);
                document.getElementById('asiaHigh').textContent = currentDay.asiaHigh.toFixed(2);
                document.getElementById('asiaLow').textContent = currentDay.asiaLow.toFixed(2);
            } else {
                document.getElementById('asiaRange').textContent = '-';
                document.getElementById('asiaHigh').textContent = '-';
                document.getElementById('asiaLow').textContent = '-';
            }

            // London session
            if (currentDay.londonManipulation) {
                document.getElementById('londonStatus').textContent = 'Detected';
                document.getElementById('londonType').textContent = currentDay.londonManipulation.toUpperCase();
                document.getElementById('londonSweep').textContent = currentDay.londonSweepPrice?.toFixed(2) || '-';
            } else {
                document.getElementById('londonStatus').textContent = 'Waiting...';
                document.getElementById('londonType').textContent = '-';
                document.getElementById('londonSweep').textContent = '-';
            }

            // NY session
            document.getElementById('nyEntered').textContent = currentDay.enteredToday ? 'Yes' : 'No';
            document.getElementById('nyStatus').textContent = currentDay.enteredToday ? 'Position taken' : 'Scanning...';
        }

        function updatePositionDisplay() {
            if (!currentPosition) return;

            const html = `
                <div class="position-grid">
                    <div class="position-item">
                        <div class="position-label">Side</div>
                        <div class="position-value ${currentPosition.side === 'long' ? 'positive' : 'negative'}">
                            ${currentPosition.side.toUpperCase()}
                        </div>
                    </div>
                    <div class="position-item">
                        <div class="position-label">Total Contracts</div>
                        <div class="position-value">${currentPosition.totalQty}</div>
                    </div>
                    <div class="position-item">
                        <div class="position-label">Remaining</div>
                        <div class="position-value">${currentPosition.remainingQty}</div>
                    </div>
                    <div class="position-item">
                        <div class="position-label">Entry Price</div>
                        <div class="position-value">${currentPosition.entryPrice.toFixed(2)}</div>
                    </div>
                    <div class="position-item">
                        <div class="position-label">Stop Loss</div>
                        <div class="position-value">${currentPosition.stopLoss.toFixed(2)}</div>
                    </div>
                    <div class="position-item">
                        <div class="position-label">TP1 (Asia Mid)</div>
                        <div class="position-value">${currentPosition.tp1.toFixed(2)} ${currentPosition.tp1Hit ? '‚úì' : ''}</div>
                    </div>
                    <div class="position-item">
                        <div class="position-label">TP2 (75% Range)</div>
                        <div class="position-value">${currentPosition.tp2.toFixed(2)}</div>
                    </div>
                    <div class="position-item">
                        <div class="position-label">Unrealized P&L</div>
                        <div class="position-value ${currentPosition.unrealizedPnL >= 0 ? 'positive' : 'negative'}">
                            $${(currentPosition.unrealizedPnL || 0).toFixed(2)}
                        </div>
                    </div>
                    <div class="position-item">
                        <div class="position-label">Entry Time</div>
                        <div class="position-value">${new Date(currentPosition.entryTime).toLocaleTimeString()}</div>
                    </div>
                </div>
            `;

            document.getElementById('positionInfo').innerHTML = html;

            if (currentPosition.unrealizedPnL != null) {
                const pnlEl = document.getElementById('openPnl');
                pnlEl.textContent = `$${currentPosition.unrealizedPnL.toFixed(2)}`;
                pnlEl.className = currentPosition.unrealizedPnL >= 0 ? 'status-value positive' : 'status-value negative';
            }
        }

        function updateTradeHistory() {
            const tbody = document.getElementById('tradeList');
            const recentTrades = trades.slice(-10).reverse();

            tbody.innerHTML = recentTrades.map(trade => {
                const side = trade.side.toLowerCase() === 'long' ? 'trade-side-long' : 'trade-side-short';
                const pnlClass = trade.pnl >= 0 ? 'trade-pnl-positive' : 'trade-pnl-negative';

                return `
                    <tr>
                        <td>${new Date(trade.exitTime).toLocaleTimeString()}</td>
                        <td class="${side}">${trade.side}</td>
                        <td>${trade.entryPrice.toFixed(2)}</td>
                        <td>${trade.exitPrice.toFixed(2)}</td>
                        <td>${trade.exitReason || 'Manual'}</td>
                        <td class="${pnlClass}">$${trade.pnl.toFixed(2)}</td>
                    </tr>
                `;
            }).join('') || '<tr><td colspan="6" style="text-align: center; color: #94a3b8;">No trades yet</td></tr>';
        }

        function addActivityLog(message, type = 'info') {
            const logEl = document.getElementById('activityLog');
            if (!logEl) return;

            if (logEl.children.length === 1 && logEl.textContent.includes('Waiting for activity')) {
                logEl.innerHTML = '';
            }

            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#94a3b8',
                success: '#22c55e',
                warning: '#eab308',
                error: '#ef4444'
            };

            const entry = document.createElement('div');
            entry.style.color = colors[type] || colors.info;
            entry.style.marginBottom = '4px';
            entry.textContent = `[${timestamp}] ${message}`;

            logEl.appendChild(entry);

            while (logEl.children.length > 50) {
                logEl.removeChild(logEl.firstChild);
            }

            logEl.scrollTop = logEl.scrollHeight;
        }

        function showAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert-box alert-${type}`;
            alert.textContent = message;
            document.body.appendChild(alert);

            setTimeout(() => {
                alert.style.animation = 'slideOut 0.3s';
                setTimeout(() => alert.remove(), 300);
            }, 3000);
        }

        // Socket connection
        function connect() {
            socket = io();

            socket.on('connect', () => {
                console.log('Connected to strategy server');
                document.getElementById('connectionStatus').className = 'status-connected';
                socket.emit('chartHistory');
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from server');
                document.getElementById('connectionStatus').className = 'status-disconnected';
            });

            socket.on('chartHistory', (data) => {
                console.log('Received chart history:', data ? data.length : 0, 'bars');
                if (chartDataLoaded) {
                    console.log('Chart data already loaded, ignoring duplicate');
                    return;
                }
                if (data && data.length > 0) {
                    updateCharts(data);
                }
            });

            socket.on('bar', (bar) => {
                console.log('Received live bar update:', bar);
                if (candleSeries && bar) {
                    const candleData = {
                        time: Math.floor(new Date(bar.timestamp).getTime() / 1000),
                        open: bar.open,
                        high: bar.high,
                        low: bar.low,
                        close: bar.close
                    };
                    candleSeries.update(candleData);

                    // Update session lines if present
                    if (bar.asiaHigh != null && asiaHighSeries) {
                        asiaHighSeries.update({ time: candleData.time, value: bar.asiaHigh });
                    }
                    if (bar.asiaLow != null && asiaLowSeries) {
                        asiaLowSeries.update({ time: candleData.time, value: bar.asiaLow });
                    }
                    if (bar.asiaMidpoint != null && asiaMidSeries) {
                        asiaMidSeries.update({ time: candleData.time, value: bar.asiaMidpoint });
                    }
                    if (bar.londonSweep != null && londonSweepSeries) {
                        londonSweepSeries.update({ time: candleData.time, value: bar.londonSweep });
                    }
                }
            });

            socket.on('tick', (tick) => {
                if (candleSeries && tick) {
                    const candleData = {
                        time: Math.floor(new Date(tick.timestamp).getTime() / 1000),
                        open: tick.open,
                        high: tick.high,
                        low: tick.low,
                        close: tick.close
                    };
                    candleSeries.update(candleData);
                }
            });

            socket.on('status', (data) => {
                updateStatus(data);
            });

            socket.on('trade', (trade) => {
                trades.push(trade);
                updateTradeHistory();
                showAlert(`Trade closed: ${trade.side} ${trade.pnl >= 0 ? 'WIN' : 'LOSS'} $${trade.pnl.toFixed(2)}`,
                          trade.pnl >= 0 ? 'success' : 'error');
            });

            socket.on('log', (data) => {
                console.log('[ACTIVITY LOG] Received:', data);
                addActivityLog(data.message, data.type || 'info');
            });
        }

        // Event handlers
        document.getElementById('btnStart').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/trading/start', { method: 'POST' });
                if (response.ok) {
                    showAlert('Trading enabled', 'success');
                }
            } catch (error) {
                showAlert('Failed to start trading', 'error');
            }
        });

        document.getElementById('btnStop').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/trading/stop', { method: 'POST' });
                if (response.ok) {
                    showAlert('Trading disabled', 'warning');
                }
            } catch (error) {
                showAlert('Failed to stop trading', 'error');
            }
        });

        document.getElementById('btnFlatten').addEventListener('click', async () => {
            if (confirm('Are you sure you want to close the current position?')) {
                try {
                    const response = await fetch('/api/position/flatten', { method: 'POST' });
                    if (response.ok) {
                        showAlert('Position flattened', 'info');
                    }
                } catch (error) {
                    showAlert('Failed to flatten position', 'error');
                }
            }
        });

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            loadAccountStatus();
            connect();

            // Fetch initial chart data via REST as fallback
            setTimeout(() => {
                if (chartDataLoaded) {
                    console.log('Chart data already loaded via socket, skipping REST fallback');
                    return;
                }
                fetch('/api/chart')
                    .then(response => response.json())
                    .then(data => {
                        if (chartDataLoaded) {
                            console.log('Chart data loaded while REST was fetching, ignoring');
                            return;
                        }
                        if (data && data.length > 0) {
                            console.log('Loaded initial chart data via REST:', data.length, 'bars');
                            updateCharts(data);
                        }
                    })
                    .catch(error => console.error('Error fetching initial chart data:', error));
            }, 1000);
        });
    </script>
</body>
</html>
