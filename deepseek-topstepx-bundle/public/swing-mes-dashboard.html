<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MES Intraday Position Trading Dashboard - FABIO</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: #e0e0e0;
      padding: 20px;
    }

    .container {
      max-width: 1800px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      font-size: 2.5em;
      margin-bottom: 10px;
      color: #fff;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .subtitle {
      text-align: center;
      font-size: 1.2em;
      margin-bottom: 30px;
      color: #a0c4ff;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .card h2 {
      margin-bottom: 15px;
      color: #4fc3f7;
      font-size: 1.5em;
      border-bottom: 2px solid #4fc3f7;
      padding-bottom: 10px;
    }

    .metric {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .metric-label {
      font-weight: 600;
      color: #b0b0b0;
    }

    .metric-value {
      font-weight: bold;
      font-size: 1.1em;
    }

    .positive {
      color: #4caf50;
    }

    .negative {
      color: #f44336;
    }

    .neutral {
      color: #ffc107;
    }

    .position-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .position-card.long {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .position-card.short {
      background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
    }

    .timeframe-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 15px;
    }

    .timeframe-box {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }

    .timeframe-label {
      font-size: 0.9em;
      color: #b0b0b0;
      margin-bottom: 5px;
    }

    .timeframe-trend {
      font-size: 1.3em;
      font-weight: bold;
      margin-top: 5px;
    }

    .bullish {
      color: #4caf50;
    }

    .bearish {
      color: #f44336;
    }

    .market-profile-viz {
      height: 300px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      margin-top: 15px;
      padding: 10px;
      overflow-y: auto;
    }

    .profile-row {
      display: flex;
      align-items: center;
      margin: 2px 0;
      font-family: monospace;
      font-size: 0.85em;
    }

    .profile-price {
      width: 80px;
      text-align: right;
      margin-right: 10px;
      color: #4fc3f7;
    }

    .profile-bar {
      height: 18px;
      background: linear-gradient(90deg, #667eea, #764ba2);
      border-radius: 3px;
      transition: width 0.3s;
    }

    .profile-bar.poc {
      background: linear-gradient(90deg, #f093fb, #f5576c);
      box-shadow: 0 0 10px rgba(240, 147, 251, 0.5);
    }

    .risk-mgmt-card {
      background: linear-gradient(135deg, #134e5e 0%, #71b280 100%);
    }

    .action-badge {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: bold;
      margin: 5px;
      font-size: 0.9em;
    }

    .action-hold {
      background: #ffc107;
      color: #000;
    }

    .action-adjust {
      background: #2196f3;
      color: #fff;
    }

    .action-close {
      background: #f44336;
      color: #fff;
    }

    .swing-levels {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .level-badge {
      background: rgba(255, 255, 255, 0.1);
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 0.9em;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .vp-composite {
      background: rgba(255, 215, 0, 0.1);
      border: 2px solid #ffd700;
      margin-top: 15px;
      padding: 15px;
      border-radius: 10px;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .live-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      background: #4caf50;
      border-radius: 50%;
      margin-right: 8px;
      animation: pulse 2s infinite;
    }

    .status-bar {
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-around;
      align-items: center;
    }

    .status-item {
      text-align: center;
    }

    .status-label {
      font-size: 0.9em;
      color: #b0b0b0;
    }

    .status-value {
      font-size: 1.5em;
      font-weight: bold;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß† FABIO INTRADAY POSITION TRADING - MES</h1>
    <p class="subtitle">
      <span class="live-indicator"></span>
      Strategic Multi-Position (Up to 5) | Higher Timeframe Bias | Flexible OCO Brackets
    </p>

    <div class="status-bar">
      <div class="status-item">
        <div class="status-label">Current Price</div>
        <div class="status-value" id="current-price">--</div>
      </div>
      <div class="status-item">
        <div class="status-label">Account Balance</div>
        <div class="status-value" id="balance">$0</div>
      </div>
      <div class="status-item">
        <div class="status-label">Daily P&L</div>
        <div class="status-value" id="daily-pnl">$0</div>
      </div>
      <div class="status-item">
        <div class="status-label">Active Positions</div>
        <div class="status-value" id="position-status">0/5</div>
      </div>
      <div class="status-item">
        <div class="status-label">Portfolio P&L</div>
        <div class="status-value" id="portfolio-pnl">$0</div>
      </div>
    </div>

    <div class="grid">
      <!-- Timeframe Analysis Card -->
      <div class="card">
        <h2>üìà Multi-Timeframe Trend Analysis</h2>
        <div class="timeframe-grid">
          <div class="timeframe-box">
            <div class="timeframe-label">4-HOUR</div>
            <div class="timeframe-trend" id="four-hour-trend">--</div>
          </div>
          <div class="timeframe-box">
            <div class="timeframe-label">1-HOUR</div>
            <div class="timeframe-trend" id="one-hour-trend">--</div>
          </div>
          <div class="timeframe-box">
            <div class="timeframe-label">15-MIN</div>
            <div class="timeframe-trend" id="fifteen-min-trend">--</div>
          </div>
          <div class="timeframe-box">
            <div class="timeframe-label">5-MIN</div>
            <div class="timeframe-trend" id="five-min-structure">--</div>
          </div>
        </div>
        <div class="metric">
          <span class="metric-label">Daily EMA Alignment</span>
          <span class="metric-value" id="ema-alignment">--</span>
        </div>
        <div class="metric">
          <span class="metric-label">Entry Zone</span>
          <span class="metric-value" id="entry-zone">--</span>
        </div>
      </div>

      <!-- Positions Card (Multiple) -->
      <div class="card" style="grid-column: span 2;">
        <h2>üìä Active Positions (Strategic Multi-Position)</h2>
        <div id="positions-content">
          <p style="text-align: center; padding: 40px 0; opacity: 0.7;">No active positions</p>
        </div>
      </div>

      <!-- Market Profile Card -->
      <div class="card">
        <h2>‚è±Ô∏è Market Profile (Time at Price)</h2>
        <div class="metric">
          <span class="metric-label">POC (Most Time)</span>
          <span class="metric-value" id="mp-poc">--</span>
        </div>
        <div class="metric">
          <span class="metric-label">Value Area High</span>
          <span class="metric-value" id="mp-vah">--</span>
        </div>
        <div class="metric">
          <span class="metric-label">Value Area Low</span>
          <span class="metric-value" id="mp-val">--</span>
        </div>
        <div class="market-profile-viz" id="market-profile-viz">
          <p style="text-align: center; opacity: 0.5;">Waiting for data...</p>
        </div>
      </div>

      <!-- Session Volume Profile Card -->
      <div class="card">
        <h2>üìÖ Session Volume Profile</h2>
        <div class="vp-composite">
          <h3 style="margin-bottom: 10px; color: #ffd700;">Current + Previous Session Profile</h3>
          <div class="metric">
            <span class="metric-label">Composite POC</span>
            <span class="metric-value" id="comp-poc">--</span>
          </div>
          <div class="metric">
            <span class="metric-label">Composite VAH</span>
            <span class="metric-value" id="comp-vah">--</span>
          </div>
          <div class="metric">
            <span class="metric-label">Composite VAL</span>
            <span class="metric-value" id="comp-val">--</span>
          </div>
        </div>
        <div class="metric">
          <span class="metric-label">High Volume Nodes</span>
          <div class="swing-levels" id="hvn-levels"></div>
        </div>
        <div class="metric">
          <span class="metric-label">Low Volume Nodes</span>
          <div class="swing-levels" id="lvn-levels"></div>
        </div>
      </div>

      <!-- Risk Management Card -->
      <div class="card risk-mgmt-card" id="risk-mgmt-card">
        <h2>üõ°Ô∏è Risk Management</h2>
        <div id="risk-mgmt-content">
          <p style="text-align: center; padding: 40px 0; opacity: 0.7;">No active risk management</p>
        </div>
      </div>

      <!-- Swing Levels Card -->
      <div class="card">
        <h2>üéØ Key Swing Levels</h2>
        <div class="metric">
          <span class="metric-label">Daily Swing Highs/Lows</span>
          <div class="swing-levels" id="daily-swing-levels"></div>
        </div>
        <div class="metric">
          <span class="metric-label">4H Swing Points</span>
          <div class="swing-levels" id="4h-swing-levels"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const socket = io('http://localhost:3350');

    socket.on('connect', () => {
      console.log('Connected to swing trading server');
    });

    socket.on('status', (data) => {
      console.log('Status update:', data);

      // Update current price
      if (data.position) {
        document.getElementById('current-price').textContent =
          data.position.entry_price ? data.position.entry_price.toFixed(2) : '--';
      }

      // Update balance
      document.getElementById('balance').textContent =
        `$${data.balance ? data.balance.toLocaleString() : '0'}`;

      // Update daily P&L
      const pnl = data.daily_pnl || 0;
      const pnlEl = document.getElementById('daily-pnl');
      pnlEl.textContent = `$${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)}`;
      pnlEl.className = 'status-value ' + (pnl >= 0 ? 'positive' : 'negative');

      // Update positions (multi-position display)
      const posContent = document.getElementById('positions-content');
      const posStatus = document.getElementById('position-status');
      const portfolioPnL = document.getElementById('portfolio-pnl');

      if (data.positions && data.positions.length > 0) {
        posStatus.textContent = `${data.positionCount}/${data.maxPositions}`;
        posStatus.className = 'status-value ' + (data.positionCount >= data.maxPositions ? 'negative' : 'positive');

        const totalPnL = data.totalPortfolioPnL || 0;
        portfolioPnL.textContent = `$${totalPnL >= 0 ? '+' : ''}${totalPnL.toFixed(2)}`;
        portfolioPnL.className = 'status-value ' + (totalPnL >= 0 ? 'positive' : 'negative');

        // Render each position
        posContent.innerHTML = data.positions.map((pos, idx) => {
          const pnl = pos.pnl || 0;
          const riskDistance = Math.abs(pos.entry_price - pos.stop_loss);
          const targetDistance = Math.abs(pos.target - pos.entry_price);
          const rr = targetDistance / riskDistance;

          return `
            <div class="card ${pos.side === 'long' ? 'long' : 'short'}" style="margin-bottom: 15px; padding: 15px;">
              <h3 style="margin-bottom: 10px;">Position #${idx + 1} - ${pos.side.toUpperCase()}</h3>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                <div class="metric">
                  <span class="metric-label">Entry</span>
                  <span class="metric-value">${pos.entry_price.toFixed(2)}</span>
                </div>
                <div class="metric">
                  <span class="metric-label">Stop</span>
                  <span class="metric-value">${pos.stop_loss.toFixed(2)}</span>
                </div>
                <div class="metric">
                  <span class="metric-label">Target</span>
                  <span class="metric-value">${pos.target.toFixed(2)}</span>
                </div>
                <div class="metric">
                  <span class="metric-label">P&L</span>
                  <span class="metric-value ${pnl >= 0 ? 'positive' : 'negative'}">
                    $${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)}
                  </span>
                </div>
                <div class="metric">
                  <span class="metric-label">R:R</span>
                  <span class="metric-value">1:${rr.toFixed(2)}</span>
                </div>
                <div class="metric">
                  <span class="metric-label">Contracts</span>
                  <span class="metric-value">${pos.contracts}</span>
                </div>
              </div>
              ${pos.riskDecision ? `
                <div style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px;">
                  <strong>Risk Mgmt:</strong> ${pos.riskDecision.action}
                  <div style="font-size: 0.85em; opacity: 0.8; margin-top: 5px;">
                    ${pos.riskDecision.reasoning.substring(0, 100)}...
                  </div>
                </div>
              ` : ''}
            </div>
          `;
        }).join('');
      } else {
        posStatus.textContent = '0/' + (data.maxPositions || 5);
        posStatus.className = 'status-value neutral';
        portfolioPnL.textContent = '$0';
        portfolioPnL.className = 'status-value neutral';
        posContent.innerHTML = '<p style="text-align: center; padding: 40px 0; opacity: 0.7;">No active positions</p>';
      }

      // Update market profile
      if (data.market_profile) {
        const mp = data.market_profile;
        document.getElementById('mp-poc').textContent = mp.poc.toFixed(2);
        document.getElementById('mp-vah').textContent = mp.vah.toFixed(2);
        document.getElementById('mp-val').textContent = mp.val.toFixed(2);

        // Render market profile visualization
        renderMarketProfile(mp);
      }

      // Update session volume profile
      if (data.session_vp) {
        const svp = data.session_vp;
        if (svp.composite) {
          document.getElementById('comp-poc').textContent = svp.composite.poc.toFixed(2);
          document.getElementById('comp-vah').textContent = svp.composite.vah.toFixed(2);
          document.getElementById('comp-val').textContent = svp.composite.val.toFixed(2);
        }

        // Render HVNs
        const hvnEl = document.getElementById('hvn-levels');
        hvnEl.innerHTML = svp.hvns ? svp.hvns.slice(0, 5).map(level =>
          `<span class="level-badge">${level.toFixed(2)}</span>`
        ).join('') : '<span style="opacity: 0.5;">--</span>';

        // Render LVNs
        const lvnEl = document.getElementById('lvn-levels');
        lvnEl.innerHTML = svp.lvns ? svp.lvns.slice(0, 5).map(level =>
          `<span class="level-badge">${level.toFixed(2)}</span>`
        ).join('') : '<span style="opacity: 0.5;">--</span>';
      }

      // Update risk management
      if (data.risk_management) {
        const rm = data.risk_management;
        const rmContent = document.getElementById('risk-mgmt-content');

        let actionClass = 'action-hold';
        if (rm.action.includes('ADJUST')) actionClass = 'action-adjust';
        if (rm.action === 'CLOSE_POSITION') actionClass = 'action-close';

        rmContent.innerHTML = `
          <div class="metric">
            <span class="metric-label">Action</span>
            <span class="action-badge ${actionClass}">${rm.action}</span>
          </div>
          <div class="metric">
            <span class="metric-label">Urgency</span>
            <span class="metric-value">${rm.urgency.toUpperCase()}</span>
          </div>
          <div class="metric">
            <span class="metric-label">Reasoning</span>
            <span class="metric-value" style="font-size: 0.9em; opacity: 0.9;">${rm.reasoning.substring(0, 200)}...</span>
          </div>
          ${rm.newStopLoss ? `
          <div class="metric">
            <span class="metric-label">New Stop</span>
            <span class="metric-value">${rm.newStopLoss.toFixed(2)}</span>
          </div>` : ''}
          ${rm.newTarget ? `
          <div class="metric">
            <span class="metric-label">New Target</span>
            <span class="metric-value">${rm.newTarget.toFixed(2)}</span>
          </div>` : ''}
        `;
      }
    });

    function renderMarketProfile(mp) {
      const viz = document.getElementById('market-profile-viz');
      if (!mp.tpo || mp.tpo.length === 0) {
        viz.innerHTML = '<p style="text-align: center; opacity: 0.5;">No market profile data</p>';
        return;
      }

      const maxTime = Math.max(...mp.tpo.map(n => n.timeSpent));
      const top20 = mp.tpo.slice(0, 20); // Show top 20 price levels

      viz.innerHTML = top20.map(node => {
        const width = (node.timeSpent / maxTime) * 100;
        const isPoc = Math.abs(node.price - mp.poc) < 0.5;

        return `
          <div class="profile-row">
            <span class="profile-price">${node.price.toFixed(2)}</span>
            <div class="profile-bar ${isPoc ? 'poc' : ''}" style="width: ${width}%"></div>
          </div>
        `;
      }).join('');
    }

    socket.on('disconnect', () => {
      console.log('Disconnected from server');
    });
  </script>
</body>
</html>
